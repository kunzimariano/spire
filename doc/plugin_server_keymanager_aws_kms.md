# Server plugin: KeyManager "aws_kms"

The `aws_kms` key manager plugin leverages the AWS Key Management Service (KMS) to create, maintain and rotate key pairs (as [customer master keys](https://docs.aws.amazon.com/kms/latest/developerguide/concepts.html#master_keys), or CMKs), and sign SVIDs as needed, with the private key never leaving KMS.

## Configuration

The plugin accepts the following configuration options:

| Key                 | Type   | Required                              | Description                                             | Default                                              |
| ------------------- | ------ | ------------------------------------- | ------------------------------------------------------- | ---------------------------------------------------- |
| access_key_id       | string | see [AWS KMS Access](#aws-kms-access) | The Access Key Id used to authenticate to KMS           | Value of AWS_ACCESS_KEY_ID environment variable      |
| secret_access_key   | string | see [AWS KMS Access](#aws-kms-access) | The Secret Access Key used to authenticate to KMS       | Value of AWS_SECRET_ACCESS_KEY environment variable  |
| region              | string | yes                                   | The region where the keys will be stored                |                                                      |
| key_metadata_file | string | yes                                   | A file path location where information about generated keys will be persisted |                                                      |   

### Alias name and Key Metadata File

The plugin uses a friendly name known as [alias](https://docs.aws.amazon.com/kms/latest/developerguide/kms-alias.html) for the customer master keys that it needs to manage. This way, it can identify the keys that are owned by the plugin.
A `Key Metadata File` must be configured in order to be able to persist an autogenerated key ID that is used to build the alias name. This is configured through the `key_metadata_file` setting.

With the goal of being able to detect keys that are not in use by any server, the plugin runs a task that sets the current date to the `LastUpdatedDate` field of the alias of all keys in the cache every 6 hours.
Aliases managed by the plugin have the following form: `alias/SPIRE_SERVER/{TRUST_DOMAIN}/{SERVER_ID}/{KEY_ID}`.

The aliases that have a `LastUpdatedDate` value older than two weeks are deleted by the plugin, along with the associated keys.

The plugin also sets a specific `Description` metadata to the keys that manages. This `Description` has the form `SPIRE_SERVER/{TRUST_DOMAIN}`. If there is a failure during the alias assignment, the plugin will identify the keys with this specific metadata and delete the keys that don't have an alias and have a `CreationDate` value older than 48 hours. 

### AWS KMS Access

Access to AWS KMS can be given by either setting the `access_key_id` and `secret_access_key`, or by ensuring that the plugin runs on an EC2 instance with a given IAM role that has a specific set of permissions.

The IAM role must have an attached policy with the following permissions:

- `kms:CreateAlias`
- `kms:CreateKey`
- `kms:DescribeKey`
- `kms:GetPublicKey`
- `kms:ListKeys`
- `kms:ListAliases`
- `kms:ScheduleKeyDeletion`
- `kms:Sign`
- `kms:UpdateAlias`
- `kms:DeleteAlias`

## Sample plugin configuration

```
KeyManager "aws_kms" {
    plugin_data {        
        region = "us-east-2"
        key_metadata_file = "./server_id"
    }
}
```

## Supported key types and TTL

The plugin creates CMKs of the same key type configured in the SPIRE Server. At the time of this writing the plugin supports all the set of keys supported by SPIRE: `rsa-2048`, `rsa-4096`, `ec-p256`, and `ec-p384`. It defaults to `ec-p256` if not specified.

In order to configure it you can set the `ca_key_type` value in the SPIRE Server config file.

You can also set the TTL that the plugin will use to rotate the CMKs by setting the `ca_ttl` config in the same config file.

For more info refer to the [Server configuration section](https://github.com/spiffe/spire/blob/master/doc/spire_server.md#server-configuration-file) in the SPIRE Server documentation and to the [full server config file](https://github.com/spiffe/spire/blob/master/conf/server/server_full.conf) for a complete Server config example.
